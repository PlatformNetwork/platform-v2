# =============================================================================
# Platform Network - Bootnode Docker Image
# =============================================================================
# Lightweight P2P relay node for validator discovery.
# Uses the same validator-node binary but configured as a bootstrap entry point.
#
# The bootnode's PeerId is derived from BOOTNODE_SECRET_KEY, so using a fixed
# key ensures a stable PeerId that validators can reference in their
# --bootstrap /ip4/<IP>/tcp/8090/p2p/<PEER_ID> argument.
#
# Build:
#   docker build -f docker/Dockerfile.bootnode -t platform-bootnode:latest .
# =============================================================================

# Build stage - reuse the same multi-stage build as the main Dockerfile
FROM rust:1.92-bookworm AS builder
ARG RUSTUP_TOOLCHAIN=stable
ENV RUSTUP_TOOLCHAIN=${RUSTUP_TOOLCHAIN}

RUN apt-get update \
    && apt-get install -y \
        pkg-config \
        libssl-dev \
        protobuf-compiler \
        cmake \
        clang \
        libclang-dev \
        lld \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app
COPY . .
RUN cargo +${RUSTUP_TOOLCHAIN} build --release -p validator-node

# Runtime stage
FROM ubuntu:24.04

RUN apt-get update && apt-get install -y \
    ca-certificates \
    libssl3t64 \
    curl \
    && rm -rf /var/lib/apt/lists/*

COPY --from=builder /app/target/release/validator-node /usr/local/bin/validator-node
COPY docker/entrypoint-bootnode.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

RUN mkdir -p /data && chmod 755 /data

# Environment defaults
ENV RUST_LOG=info,validator_node=debug,platform_p2p_consensus=info
ENV DATA_DIR=/data
ENV SUBTENSOR_ENDPOINT=wss://entrypoint-finney.opentensor.ai:443
ENV NETUID=100
ENV P2P_PORT=8090

# P2P port only - bootnode doesn't need RPC
EXPOSE 8090

HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
    CMD test -e /data/distributed.db || exit 1

ENTRYPOINT ["/entrypoint.sh"]

LABEL org.opencontainers.image.source="https://github.com/PlatformNetwork/platform"
LABEL org.opencontainers.image.description="Platform Bootnode - P2P Discovery Relay"
LABEL org.opencontainers.image.licenses="Apache-2.0"
