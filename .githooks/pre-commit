#!/bin/bash
set -e

# Skip hooks when SKIP_GIT_HOOKS=1 is set
if [ "${SKIP_GIT_HOOKS:-0}" = "1" ]; then
  echo "[pre-commit] Skipped (SKIP_GIT_HOOKS=1)"
  exit 0
fi

echo "[pre-commit] Running checks..."

# ------------------------------------------------------------------
# 1. Reject unresolved work markers in staged files
# ------------------------------------------------------------------
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM 2>/dev/null || true)

if [ -n "$STAGED_FILES" ]; then
  MARKER_FOUND=0
  for file in $STAGED_FILES; do
    # Skip AGENTS.md files (they document these rules) and hook scripts
    case "$file" in
      AGENTS.md|*/AGENTS.md|.githooks/*) continue ;;
    esac
    if [ -f "$file" ]; then
      if grep -Pn '\bTODO\b|\bFIXME\b' "$file" >/dev/null 2>&1; then
        echo "[pre-commit] ERROR: Unresolved work marker found in $file:"
        grep -Pn '\bTODO\b|\bFIXME\b' "$file" || true
        MARKER_FOUND=1
      fi
    fi
  done

  if [ "$MARKER_FOUND" -eq 1 ]; then
    echo "[pre-commit] Commit rejected: remove all unresolved work markers or create GitHub Issues instead."
    exit 1
  fi
fi

# ------------------------------------------------------------------
# 2. Validate JSON files if staged
# ------------------------------------------------------------------
for file in $STAGED_FILES; do
  if [ -f "$file" ] && echo "$file" | grep -q '\.json$'; then
    if command -v python3 >/dev/null 2>&1; then
      python3 -c "import json; json.load(open('$file'))" 2>/dev/null || {
        echo "[pre-commit] ERROR: Invalid JSON in $file"
        exit 1
      }
    fi
  fi
done

# ------------------------------------------------------------------
# 3. Check for large files (>5MB)
# ------------------------------------------------------------------
for file in $STAGED_FILES; do
  if [ -f "$file" ]; then
    FILE_SIZE=$(wc -c < "$file" 2>/dev/null || echo 0)
    if [ "$FILE_SIZE" -gt 5242880 ]; then
      echo "[pre-commit] ERROR: File $file is larger than 5MB ($FILE_SIZE bytes). Use Git LFS for large files."
      exit 1
    fi
  fi
done

# ------------------------------------------------------------------
# 4. Check for secrets patterns in staged files
# ------------------------------------------------------------------
for file in $STAGED_FILES; do
  if [ -f "$file" ]; then
    if grep -Pn '(?i)(api[_-]?key|secret[_-]?key|password|token)\s*[:=]\s*["\x27][A-Za-z0-9+/=]{16,}' "$file" >/dev/null 2>&1; then
      echo "[pre-commit] WARNING: Potential secret detected in $file. Review before committing."
    fi
  fi
done

echo "[pre-commit] All checks passed."
