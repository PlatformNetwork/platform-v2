#!/bin/bash
set -e

# Skip hooks when SKIP_GIT_HOOKS=1 is set
if [ "${SKIP_GIT_HOOKS:-0}" = "1" ]; then
  echo "[pre-push] Skipped (SKIP_GIT_HOOKS=1)"
  exit 0
fi

echo "[pre-push] Running quality gate..."

# ------------------------------------------------------------------
# 1. Verify critical files exist
# ------------------------------------------------------------------
if [ ! -f "AGENTS.md" ]; then
  echo "[pre-push] ERROR: AGENTS.md is missing at project root."
  exit 1
fi

if [ ! -f "VERSION" ]; then
  echo "[pre-push] ERROR: VERSION file is missing at project root."
  exit 1
fi

if [ ! -s "VERSION" ]; then
  echo "[pre-push] ERROR: VERSION file is empty."
  exit 1
fi

# ------------------------------------------------------------------
# 2. Validate version.json
# ------------------------------------------------------------------
if [ -f "version.json" ]; then
  if command -v python3 >/dev/null 2>&1; then
    python3 -c "import json; json.load(open('version.json'))" 2>/dev/null || {
      echo "[pre-push] ERROR: version.json is not valid JSON."
      exit 1
    }
  fi
fi

# ------------------------------------------------------------------
# 3. Validate .releaserc.json
# ------------------------------------------------------------------
if [ -f ".releaserc.json" ]; then
  if command -v python3 >/dev/null 2>&1; then
    python3 -c "import json; json.load(open('.releaserc.json'))" 2>/dev/null || {
      echo "[pre-push] ERROR: .releaserc.json is not valid JSON."
      exit 1
    }
  fi
fi

# ------------------------------------------------------------------
# 4. Scan for TODO/FIXME across the entire project
# ------------------------------------------------------------------
if command -v rg >/dev/null 2>&1; then
  if rg -n "TODO|FIXME" --glob '!.git' --glob '!node_modules' --glob '!target' --glob '!dist' --glob '!vendor' . >/dev/null 2>&1; then
    echo "[pre-push] ERROR: TODO/FIXME markers found in the project:"
    rg -n "TODO|FIXME" --glob '!.git' --glob '!node_modules' --glob '!target' --glob '!dist' --glob '!vendor' . || true
    exit 1
  fi
elif command -v grep >/dev/null 2>&1; then
  if grep -rn "TODO\|FIXME" --exclude-dir=.git --exclude-dir=node_modules --exclude-dir=target --exclude-dir=dist --exclude-dir=vendor . >/dev/null 2>&1; then
    echo "[pre-push] ERROR: TODO/FIXME markers found in the project:"
    grep -rn "TODO\|FIXME" --exclude-dir=.git --exclude-dir=node_modules --exclude-dir=target --exclude-dir=dist --exclude-dir=vendor . || true
    exit 1
  fi
fi

# ------------------------------------------------------------------
# 5. Language-specific checks (activated when tooling is detected)
# ------------------------------------------------------------------

# --- Node.js / TypeScript ---
if [ -f "package.json" ]; then
  echo "[pre-push] Detected Node.js project..."
  if command -v npm >/dev/null 2>&1; then
    if grep -q '"lint"' package.json 2>/dev/null; then
      npm run lint
    fi
    if grep -q '"test"' package.json 2>/dev/null; then
      npm test
    fi
    if grep -q '"build"' package.json 2>/dev/null; then
      npm run build
    fi
  fi
fi

# --- Rust ---
if [ -f "Cargo.toml" ]; then
  echo "[pre-push] Detected Rust project..."
  if command -v cargo >/dev/null 2>&1; then
    cargo fmt --check
    cargo clippy -- -D warnings
    cargo test
    cargo build --release
  fi
fi

# --- Python ---
if [ -f "pyproject.toml" ] || [ -f "setup.py" ] || [ -f "requirements.txt" ]; then
  echo "[pre-push] Detected Python project..."
  if command -v python3 >/dev/null 2>&1; then
    if command -v ruff >/dev/null 2>&1; then
      ruff check .
      ruff format --check .
    elif command -v flake8 >/dev/null 2>&1; then
      flake8 .
    fi
    if command -v pytest >/dev/null 2>&1; then
      pytest
    fi
  fi
fi

# --- Go ---
if [ -f "go.mod" ]; then
  echo "[pre-push] Detected Go project..."
  if command -v go >/dev/null 2>&1; then
    go fmt ./...
    go vet ./...
    go test ./...
    go build ./...
  fi
fi

echo "[pre-push] All quality gate checks passed."
