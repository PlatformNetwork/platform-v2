# =============================================================================
# Platform Validator Configuration
# =============================================================================
# Usage:
#   cp .env.example .env
#   # Edit .env with your VALIDATOR_SECRET_KEY
#   docker compose up -d
# =============================================================================

services:
  # ==========================================================================
  # Platform Validator Node
  # ==========================================================================
  validator:
    image: ghcr.io/platformnetwork/platform:latest
    container_name: platform-validator
    restart: unless-stopped

    labels:
      - "com.centurylinklabs.watchtower.enable=true"

    ports:
      - "8080:8080"   # JSON-RPC API
      - "8090:8090"   # P2P libp2p

    volumes:
      - validator-data:/data

    environment:
      - RUST_LOG=${RUST_LOG:-info,validator_node=debug}
      - DATA_DIR=/data
      - VALIDATOR_SECRET_KEY=${VALIDATOR_SECRET_KEY}
      - SUBTENSOR_ENDPOINT=${SUBTENSOR_ENDPOINT:-wss://entrypoint-finney.opentensor.ai:443}
      - NETUID=${NETUID:-100}
      - RPC_PORT=8080
      - P2P_PORT=8090
      - WITH_BOOTNODE=${WITH_BOOTNODE:-true}
      - BOOTNODE_PORT=8090

    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8080/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ==========================================================================
  # Watchtower - Auto-update validator
  # ==========================================================================
  watchtower:
    image: containrrr/watchtower:latest
    container_name: platform-watchtower
    restart: unless-stopped

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

    environment:
      - WATCHTOWER_LABEL_ENABLE=true
      - WATCHTOWER_SCHEDULE=0 */5 * * * *
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_LOG_LEVEL=info

volumes:
  validator-data:
    driver: local
